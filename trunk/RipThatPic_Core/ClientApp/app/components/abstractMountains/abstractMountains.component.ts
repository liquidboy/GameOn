import { Component, ElementRef, ViewChild, AfterViewInit } from '@angular/core';

declare var XG: any;

@Component({
    selector: 'abstract-mountains',
    templateUrl: './abstractMountains.component.html',
    styleUrls: ['./abstractMountains.component.css']
})
export class AbstractMountainsComponent implements AfterViewInit {
    // http://alteredqualia.com/xg/examples/abstract_mountains.html
    
    @ViewChild('container') containerEl: ElementRef;

    constructor() {

        // if (!Detector.deferredCapable) this.useDeferred = false;

    }

    ngAfterViewInit(): void {
        this.loadingElement = this.loadingEl.nativeElement;
        this.containerElement = this.containerEl.nativeElement;

        this.init();
        this.animate();

    }



    useDeferred: boolean = true;

    isUltra: boolean = false;
    ULTRA_THRESHOLD: number = 4000;

    SCALE: number = 1;
    MARGIN: number = 100;

    BRIGHTNESS: number = 1.0;

    SCREEN_WIDTH: number = window.innerWidth;
    SCREEN_HEIGHT: number = window.innerHeight - 2 * this.MARGIN;

    //

    // container: any;
    containerElement: any;
    camera: any;
    scene: any;
    renderer: any;
    light: any;
    mesh: any;
    innerRenderer: any;

    clearColor = new XG.Color();

    zmaterials: any;;
    zgeometries: any;;
    zmeshes: any = [];

    //

    presetIndex: number = 0;

    presets =
    [

        { "ground": [0.8658264274708927, 0.3832095405086875, 0.3788921151543036], "edgeDiffuse": [0.30314077041111887, 0.46511098742485046, 0.8931776874233037], "edgeSpecular": [0.5594328481238335, 0.5114806385245174, 0.041122205555438995], "sky": [0.04106688196770847, 0.5536626887507736, 0.7510033313417807], "sun": [0.36834337119944394, 0.22971975130494682, 0.8640622841194272], "sunHeight": 2.91894607944414 },
        { "ground": [0.03088764171116054, 0.4331382163800299, 0.4176456465851516], "edgeDiffuse": [0.6406863608863205, 0.6428779219277203, 0.08705327822826803], "edgeSpecular": [0.7186671905219555, 0.6572450557723641, 0.2677586458157748], "sky": [0.7134595513343811, 0.5901406951365061, 0.4202856989926658], "sun": [0.6081256282050163, 0.5637845918070524, 0.9774826585780829], "sunHeight": 4.604357632342726 },
        { "ground": [0.4802729038055986, 0.23042125161737204, 0.4228358172811567], "edgeDiffuse": [0.08836238947696984, 0.17206342471763492, 0.23196404776535928], "edgeSpecular": [0.31350752618163824, 0.7828571156132966, 0.9109244006685913], "sky": [0.08514704508706927, 0.20036301285726948, 0.6425055760541], "sun": [0.02301325765438378, 0.05790681591024622, 0.8195106755010784], "sunHeight": 33.49967997055501 },
        { "ground": [0.2096772138029337, 0.2239093080861494, 0.19832360940054058], "edgeDiffuse": [0.06549201160669327, 0.987966291140765, 0.9515167626086622], "edgeSpecular": [0.24735273490659893, 0.6741389618255198, 0.6914652597624809], "sky": [0.9532475757878274, 0.2911202306509949, 0.395411364082247], "sun": [0.42254621791653335, 0.33320652942638845, 0.9318602797575295], "sunHeight": 21.429308131337166 },
        { "ground": [0.47663089679554105, 0.34247457433957607, 0.31099416716024275], "edgeDiffuse": [0.6390309960115701, 0.6534709432162344, 0.0170815906021744], "edgeSpecular": [0.7418750822544098, 0.010827147169038653, 0.26133140781894326], "sky": [0.034557525999844074, 0.8238936679787002, 0.4755617115180939], "sun": [0.692997359437868, 0.7642498935689218, 0.5795401816722006], "sunHeight": 6.286813097540289 },
        { "ground": [0.5615517196711153, 0.40507024293765426, 0.4159549901029095], "edgeDiffuse": [0.6915473323315382, 0.7311213270295411, 0.09667993942275643], "edgeSpecular": [0.9103195257484913, 0.11224321788176894, 0.7283902047201991], "sky": [0.33591905795037746, 0.40802344025578346, 0.742456158506684], "sun": [0.0077435472048819065, 0.6638728381600231, 0.48806729121133685], "sunHeight": 38.82279528770596 },
        { "ground": [0.4102351658511907, 0.3531937705120072, 0.16689487940166145], "edgeDiffuse": [0.1769875434692949, 0.20394614338874817, 0.9735954126808792], "edgeSpecular": [0.3722554377745837, 0.7446137287188321, 0.48647989402525127], "sky": [0.8303552749566734, 0.5020975429448299, 0.39918197176884856], "sun": [0.013778925640508533, 0.5180630057468079, 0.09821950737386942], "sunHeight": 39.819781319238245 },
        { "ground": [0.8231741024646908, 0.4652556648943573, 0.17197005576454102], "edgeDiffuse": [0.2850940527860075, 0.13692864566110075, 0.6940125953406096], "edgeSpecular": [0.5375218940898776, 0.5303139192983508, 0.5281881140545011], "sky": [0.862074560020119, 0.13545661133248357, 0.874736691720318], "sun": [0.36200548941269517, 0.09928627678891644, 0.368861791677773], "sunHeight": 20.351168350316584 },
        { "ground": [0.6752230713609606, 0.1259754414204508, 0.33765075320843607], "edgeDiffuse": [0.749025386525318, 0.12355373776517808, 0.8200588098261505], "edgeSpecular": [0.6230252913665026, 0.1570082171820104, 0.8395875550340861], "sky": [0.5913920931052417, 0.8503769981791265, 0.2761235993821174], "sun": [0.6552007128484547, 0.2702453317469917, 0.8921196572482586], "sunHeight": 36.662817595060915 },
        { "ground": [0.9440798184368759, 0.3812089099083096, 0.2787036502500996], "edgeDiffuse": [0.3392617560457438, 0.869063085410744, 0.04810390644706786], "edgeSpecular": [0.09516326570883393, 0.7411975141149014, 0.7842585304751992], "sky": [0.4046253953129053, 0.2501613060128875, 0.7481751089333556], "sun": [0.6328319455496967, 0.09610338493948802, 0.9178471956402063], "sunHeight": 40.17292407806963 },
        { "ground": [0.48374441638588905, 0.4737093679141253, 0.1750367144588381], "edgeDiffuse": [0.08408177783712745, 0.15792929660528898, 0.4733989932574332], "edgeSpecular": [0.8698735947255045, 0.8339924919418991, 0.9775962859857827], "sky": [0.2412060545757413, 0.8439053230686113, 0.4679657697561197], "sun": [0.538035832112655, 0.6882784025627188, 0.9292331370525062], "sunHeight": 10.573054489213973 },
        { "ground": [0.012294173007830977, 0.2703731576912105, 0.3189054389018565], "edgeDiffuse": [0.9492246950976551, 0.5449223136529326, 0.20256024599075317], "edgeSpecular": [0.10259961057454348, 0.7595434205140918, 0.4756993455812335], "sky": [0.03927285363897681, 0.8826585850561969, 0.7809118061210029], "sun": [0.027850873302668333, 0.29716146290302276, 0.6098650044295937], "sunHeight": 46.05052937986329 },
        { "ground": [0.7698824584949762, 0.009532204596325755, 0.399499155418016], "edgeDiffuse": [0.47863097744993865, 0.7046116862911731, 0.16167347552254796], "edgeSpecular": [0.6507834370713681, 0.6496697622351348, 0.516446468885988], "sky": [0.047528412425890565, 0.7178217242006212, 0.4566028951434418], "sun": [0.8106023469008505, 0.11184756838483735, 0.7426946179475635], "sunHeight": 37.59157449239865 },
        { "ground": [0.7182379034347832, 0.4576970003545284, 0.3538681501988321], "edgeDiffuse": [0.27457715733908117, 0.44269362185150385, 0.7399658905342221], "edgeSpecular": [0.541413945844397, 0.8516887915320694, 0.021747303195297718], "sky": [0.5954886090476066, 0.5739761592587456, 0.3615015176706947], "sun": [0.008194925729185343, 0.7998717036680318, 0.6261866714339703], "sunHeight": 8.27805248554796 },
        { "ground": [0.18051527929492295, 0.3337181967217475, 0.41914888517931104], "edgeDiffuse": [0.46064252965152264, 0.41210576379671693, 0.1836418544407934], "edgeSpecular": [0.9019970942754298, 0.1769659905694425, 0.7680216280277818], "sky": [0.13404675642959774, 0.6357160302926786, 0.23521170131862162], "sun": [0.21578732505440712, 0.45885283742099997, 0.5801737292204052], "sunHeight": 29.608908959198743 },
        { "ground": [0.6180391658563167, 0.07686163927428424, 0.3564869239227846], "edgeDiffuse": [0.4204081834759563, 0.9439312419854105, 0.06446904013864696], "edgeSpecular": [0.698198459809646, 0.6706537161953747, 0.8139374528545886], "sky": [0.6246562744490802, 0.41806939891539513, 0.49051642855629324], "sun": [0.49515333911404014, 0.6224136985489167, 0.790493598440662], "sunHeight": 28.14488362055272 },
        { "ground": [0.09566717292182148, 0.420459138113074, 0.3501750939292833], "edgeDiffuse": [0.48076520790345967, 0.3368587950244546, 0.5923489506822079], "edgeSpecular": [0.5023351137060672, 0.2763198968023062, 0.9381271156016737], "sky": [0.09450360224582255, 0.9083521566586569, 0.3255755276419222], "sun": [0.09255870431661606, 0.6390042466460727, 0.412392845377326], "sunHeight": 23.45858250046149 },
        { "ground": [0.10408218461088836, 0.3475433352869004, 0.2658803688827902], "edgeDiffuse": [0.18907200382091105, 0.20931925904005766, 0.8177367206662893], "edgeSpecular": [0.47681483649648726, 0.9299959721975029, 0.8991220330353826], "sky": [0.7973537500947714, 0.38931536253076043, 0.008447079232428222], "sun": [0.230254648020491, 0.2159019120153971, 0.6405488075688481], "sunHeight": 7.785016542766243 },
        { "ground": [0.8959822633769363, 0.39624082017689943, 0.35080542729701847], "edgeDiffuse": [0.46822650195099413, 0.01776095200330019, 0.08869513194076717], "edgeSpecular": [0.45503120380453765, 0.14228296652436256, 0.3064644418191165], "sky": [0.9788860904518515, 0.2506948110531084, 0.11859719393542036], "sun": [0.7963311558123678, 0.7470922008855267, 0.14577172603458166], "sunHeight": 19.959267834201455 },
        { "ground": [0.29073268361389637, 0.4997693622717634, 0.3154170446796343], "edgeDiffuse": [0.08961886377073824, 0.8919980723876506, 0.4787209436763078], "edgeSpecular": [0.5904388551134616, 0.7640290500130504, 0.4940148808527738], "sky": [0.45862920861691236, 0.016336935095023365, 0.1727838058490306], "sun": [0.11193950730375946, 0.2857361406320706, 0.8416231216397136], "sunHeight": 18.950363737531006 },
        { "ground": [0.959421202307567, 0.14683835813775659, 0.19375450916122644], "edgeDiffuse": [0.3074878433253616, 0.9488539467565715, 0.8958718404173851], "edgeSpecular": [0.6392092276364565, 0.923085839021951, 0.3162592949811369], "sky": [0.5945591744966805, 0.1331119757844135, 0.26446856049587947], "sun": [0.2542569632641971, 0.05588839382398873, 0.642003838904202], "sunHeight": 12.268596526701003 },
        { "ground": [0.041377651039510965, 0.453447109204717, 0.22612160865683106], "edgeDiffuse": [0.9158749231137335, 0.19476994569413364, 0.8321786317974329], "edgeSpecular": [0.15290942462161183, 0.0069229318760335445, 0.6696021773386747], "sky": [0.053068930050358176, 0.7668083541793749, 0.09405832084594294], "sun": [0.17445484502241015, 0.4066936847171746, 0.4264380543027073], "sunHeight": 39.18472905643284 },
        { "ground": [0.07336612301878631, 0.4865885915933177, 0.2598916331771761], "edgeDiffuse": [0.01690583908930421, 0.6813178220763803, 0.9325635307468474], "edgeSpecular": [0.7016338969115168, 0.48316915635950863, 0.4650073575321585], "sky": [0.17486380622722208, 0.7699057066696695, 0.00696993499295786], "sun": [0.27862800331786275, 0.5886024631094188, 0.8853668721858412], "sunHeight": 11.209425400011241 },
        { "ground": [0.2866825920064002, 0.0102554967161268, 0.40042319186031816], "edgeDiffuse": [0.3782579929102212, 0.12197861401364207, 0.10599003615789115], "edgeSpecular": [0.22459599608555436, 0.6615600816439837, 0.9896532534621656], "sky": [0.9890726048033684, 0.7324580804328433, 0.3150848182849586], "sun": [0.13278068602085114, 0.8315137817291542, 0.23860674491152167], "sunHeight": 11.458822467830032, "sunX": 1.6179595957510173, "sunZ": 15.445534710306674 },
        { "ground": [0.9325274061411619, 0.23038382874801755, 0.3474864882649854], "edgeDiffuse": [0.5507149344775826, 0.4412852718960494, 0.5052730131428689], "edgeSpecular": [0.9046859899535775, 0.5316495827864856, 0.8394105709157884], "sky": [0.036412166664376855, 0.5374292681692168, 0.626405458629597], "sun": [0.4667869540862739, 0.24124031915562227, 0.6083482280373573], "sunHeight": 19.661338650621474, "sunX": 40.58235748670995, "sunZ": -40.757275628857315 },
        { "ground": [0.996549418894574, 0.39431880856864154, 0.2603353441692889], "edgeDiffuse": [0.4008698076941073, 0.7031620626803488, 0.00426794309169054], "edgeSpecular": [0.3371250578202307, 0.23824482201598585, 0.4783437086734921], "sky": [0.9508118194062263, 0.02592678698711097, 0.1604970464366488], "sun": [0.8163892405573279, 0.2858732433756813, 0.7865817476995289], "sunHeight": 1.787869946565479, "sunX": 31.31118672899902, "sunZ": -11.052659549750388 },
        { "ground": [0.06291365064680576, 0.26823481591418386, 0.3133395062293857], "edgeDiffuse": [0.8211442634928972, 0.10913524404168129, 0.8553079233970493], "edgeSpecular": [0.8355167345143855, 0.399662071140483, 0.06727094994857907], "sky": [0.10530710918828845, 0.770075178449042, 0.013744707533624022], "sun": [0.03295400459319353, 0.9303883554646745, 0.777156628202647], "sunHeight": 10.036686528474092, "sunX": -13.563657971099019, "sunZ": -22.571177734062076 },
        { "ground": [0.7670628665946424, 0.12694512482266873, 0.3271475164219737], "edgeDiffuse": [0.26677240640856326, 0.8741123173385859, 0.09154079970903695], "edgeSpecular": [0.5075364587828517, 0.7946242622565478, 0.07870855485089123], "sky": [0.6611656495369971, 0.7600276688113808, 0.48643002762692045], "sun": [0.011489120312035084, 0.02667798502370715, 0.2165490307379514], "sunHeight": 8.920322800986469, "sunX": 21.546294959262013, "sunZ": 18.652399349957705 },
        { "ground": [0.1307657416909933, 0.3285647901939228, 0.42152338537853207], "edgeDiffuse": [0.86256457795389, 0.2280700181145221, 0.12055183248594403], "edgeSpecular": [0.6843449454754591, 0.9249998901505023, 0.718173012137413], "sky": [0.4788892862852663, 0.25904052749974654, 0.17001281125703827], "sun": [0.6350743840448558, 0.35698560597375034, 0.1805261152330786], "sunHeight": 36.26383172813803, "sunX": 8.667398267425597, "sunZ": 35.822933237068355 },
        { "ground": [0.8601762678008527, 0.4895786506822333, 0.2784669387387112], "edgeDiffuse": [0.707264116499573, 0.03201934089884162, 0.3878871528431773], "edgeSpecular": [0.12388185667805374, 0.5092460280284286, 0.4792429299559444], "sky": [0.45668172859586775, 0.0498618199955672, 0.23697864443529396], "sun": [0.6102733290754259, 0.05376580427400768, 0.5730254952795804], "sunHeight": 22.273279051296413, "sunX": 39.317656005732715, "sunZ": -46.4329453650862 },
        { "ground": [0.22024908824823797, 0.12878971500322223, 0.15543396554421632], "edgeDiffuse": [0.185709459008649, 0.3192124292254448, 0.20200309017673135], "edgeSpecular": [0.6335159277077764, 0.2696984682697803, 0.5738913656678051], "sky": [0.07299744128249586, 0.8884801639127544, 0.4065119756502099], "sun": [0.33435743232257664, 0.43585560643114146, 0.0037604139652103186], "sunHeight": 40.23799522547051, "sunX": 11.712528695352376, "sunZ": 23.644451005384326 },
        { "ground": [0.15765441535040736, 0.28979696915484965, 0.16447596698999403], "edgeDiffuse": [0.8417495058383793, 0.5989082674495876, 0.5332773262634873], "edgeSpecular": [0.07614275813102722, 0.8419619905762374, 0.3697530103381723], "sky": [0.9175854357890785, 0.9217427955009043, 0.7374803152400999], "sun": [0.7917458759620786, 0.14795139158377424, 0.05138119589537382], "sunHeight": 17.915655812248588, "sunX": -21.272567799314857, "sunZ": -6.822354276664555 },
        { "ground": [0.7604346317239106, 0.2614918239414692, 0.31015499553177506], "edgeDiffuse": [0.4227293995209038, 0.6550232388544828, 0.019396762596443295], "edgeSpecular": [0.35109035670757294, 0.290150013519451, 0.4266999058891088], "sky": [0.8526032587978989, 0.36584509650710967, 0.31940327379852534], "sun": [0.011154224397614598, 0.1921601836918853, 0.9403267300222069], "sunHeight": 3.854910156223923, "sunX": -35.54339879192412, "sunZ": -3.0105866957455873 },
        { "ground": [0.973329967353493, 0.10233157023321837, 0.18693877661135047], "edgeDiffuse": [0.3699115179479122, 0.4836008457932621, 0.35209937556646764], "edgeSpecular": [0.9670509062707424, 0.7833753251470625, 0.44467083853669465], "sky": [0.4339825150091201, 0.6365724437870085, 0.5338547851075418], "sun": [0.15517580998130143, 0.7684260583482683, 0.9400877996813506], "sunHeight": 42.1059443266131, "sunX": 13.372801383957267, "sunZ": -42.710357112810016 },
        { "ground": [0.5528901803772897, 0.2805212177336216, 0.3347909970441833], "edgeDiffuse": [0.05414462019689381, 0.32308361446484923, 0.04526409134268761], "edgeSpecular": [0.035704504465684295, 0.6657142338808626, 0.7692109018098563], "sky": [0.08284346479922533, 0.5861914088949561, 0.15414643984986467], "sun": [0.477830026531592, 0.28607903064694257, 0.5450679182540625], "sunHeight": 25.015095388516784, "sunX": -12.2839598916471, "sunZ": -32.101412885822356 },
        { "ground": [0.5672078791540116, 0.42284136277157813, 0.3399467021226883], "edgeDiffuse": [0.9813517176080495, 0.6832812880165875, 0.6878582031931728], "edgeSpecular": [0.8945899759419262, 0.39797227759845555, 0.5456461429130286], "sky": [0.14064222271554172, 0.8864570068311877, 0.8837771463557146], "sun": [0.6406422227155417, 0.2392572457436472, 0.0449770234990865], "sunHeight": 41.80292598903179, "sunX": 39.129817904904485, "sunZ": -19.613672187551856 },
        { "ground": [0.7850007060915232, 0.1857253445778042, 0.2591847751988098], "edgeDiffuse": [0.34975194721482694, 0.04524881485849619, 0.8150666586589068], "edgeSpecular": [0.8931195591576397, 0.9127704461570829, 0.40772592066787183], "sky": [0.6069309217855334, 0.9137238622992299, 0.5241125578060746], "sun": [0.10693092178553343, 0.33963424076791854, 0.8437680688221008], "sunHeight": 9.298382885754108, "sunX": -42.95711126178503, "sunZ": 21.136046317406 },
        { "ground": [0.9735430984292179, 0.013200865709222853, 0.21553842248395083], "edgeDiffuse": [0.9667186161968857, 0.8138075775932521, 0.025817665038630366], "edgeSpecular": [0.8425600954797119, 0.41355774411931634, 0.4247324955649674], "sky": [0.4449945178348571, 0.20333682923810556, 0.16538994688307865], "sun": [0.9449945178348571, 0.8141151302726939, 0.8357013296335936], "sunHeight": 39.35156211955473, "sunX": -33.87515291105956, "sunZ": -13.304616720415652 },
        { "ground": [0.4956951558124274, 0.019974652922246608, 0.4342524758074432], "edgeDiffuse": [0.027108065551146865, 0.8427858010400087, 0.2125351270660758], "edgeSpecular": [0.43586065620183945, 0.6731525340583175, 0.8607837706804276], "sky": [0.04705697996541858, 0.2289550755522214, 0.1847978673991747], "sun": [0.5470569799654186, 0.23241316315252333, 0.9878204213455319], "sunHeight": 12.481846567243338, "sunX": -33.101541572250426, "sunZ": 20.290823001414537 },
        { "ground": [0.7549154963344336, 0.016829283349215986, 0.3647062618285417], "edgeDiffuse": [0.07834687060676515, 0.5952395796775818, 0.020302120130509138], "edgeSpecular": [0.8567904832307249, 0.95843425556086, 0.544704619795084], "sky": [0.06800534925423563, 0.8762245388585143, 0.6445029385038651], "sun": [0.5680053492542356, 0.17550517776980995, 0.015656392090022564], "sunHeight": 15.991150331683457, "sunX": -34.01440978050232, "sunZ": -29.713833704590797 },
        { "ground": [0.31723340321332216, 0.03647121322574094, 0.28674903684295716], "edgeDiffuse": [0.0040183227974921465, 0.48364368872717023, 0.07679690350778401], "edgeSpecular": [0.7399580681230873, 0.3239860855974257, 0.4657760504633188], "sky": [0.5166068987455219, 0.3299284404376522, 0.7424571576179004], "sun": [0.016606898745521903, 0.9358709339168854, 0.9769333864096552], "sunHeight": 14.78416936006397, "sunX": -30.913961003534496, "sunZ": -26.81334214285016 },
        { "ground": [0.2956294526811689, 0.01747403166955337, 0.16869960101321338], "edgeDiffuse": [0.04069879720918834, 0.8565821601077914, 0.9211054998449981], "edgeSpecular": [0.6697545724455267, 0.6822794394101948, 0.44448575493879616], "sky": [0.610981373116374, 0.16324826849158852, 0.236556034325622], "sun": [0.11098137311637402, 0.37014373812125995, 0.8796053775586188], "sunHeight": 8.354781160596758, "sunX": 26.183386286720634, "sunZ": 26.08480555936694 },
        { "ground": [0.6788786062970757, 0.000039834470953792334, 0.2978438781341538], "edgeDiffuse": [0.10209317598491907, 0.6381121801678091, 0.10270057269372046], "edgeSpecular": [0.14547990541905165, 0.09120591566897929, 0.40816654032096267], "sky": [0.706011044094339, 0.3504671686096117, 0.6393182628555223], "sun": [0.206011044094339, 0.5139317627064883, 0.8715085273142904], "sunHeight": 19.863160175736994, "sunX": 38.39588582050055, "sunZ": 35.23578275926411 },
        { "ground": [0.7510609882883728, 0.03407058126758784, 0.385573722445406], "edgeDiffuse": [0.3696388613898307, 0.47033109702169895, 0.0011419577058404684], "edgeSpecular": [0.9302301513962448, 0.11071013030596077, 0.2222676952369511], "sky": [0.4879900706000626, 0.19849038558313623, 0.020963328320067375], "sun": [0.9879900706000626, 0.8314123877556994, 0.28233663458377123], "sunHeight": 35.57571485871449, "sunX": -3.9908815175294876, "sunZ": -0.7618406089022756 },
        { "ground": [0.37941317702643573, 0.0467821063939482, 0.3495704816188663], "edgeDiffuse": [0.17621493176557124, 0.09629521332681179, 0.0302286297082901], "edgeSpecular": [0.21309114014729857, 0.17750012199394405, 0.20756235485896468], "sky": [0.031221284065395594, 0.8508057480561546, 0.37051411641295995], "sun": [0.5312212840653956, 0.19997183305677024, 0.33206379995681345], "sunHeight": 6.57891056034714, "sunX": -8.365305559709668, "sunZ": 7.536069373600185 },
        { "ground": [0.30818942561745644, 0.03579021000768989, 0.382435385347344], "edgeDiffuse": [0.10435821884311736, 0.682113786926493, 0.5377658300567418], "edgeSpecular": [0.4852465055882931, 0.17601371137425303, 0.596184870461002], "sky": [0.09967908798716962, 0.19518174683908, 0.1793715862208046], "sun": [0.5996790879871696, 0.06306274980306625, 0.806405683979392], "sunHeight": 17.343163234181702, "sunX": -10, "sunZ": -20 },
        { "ground": [0.6878502189647406, 0.041602113808039576, 0.3638018352678045], "edgeDiffuse": [0.6733106258325279, 0.9681590483523905, 0.01820631860755384], "edgeSpecular": [0.5201369745191187, 0.07402047258801758, 0.7306641107425094], "sky": [0.47971903532743454, 0.09573202456813305, 0.9479415776324458], "sun": [0.9797190353274345, 0.6518226692569442, 0.13907440332695842], "sunHeight": 29.785060475114733, "sunX": -10, "sunZ": -20 },
        { "ground": [0.7452015450689942, 0.046656645089387896, 0.26151614002883433], "edgeDiffuse": [0.07663482031784952, 0.7460237834602594, 0.7158085969276726], "edgeSpecular": [0.35678197629749775, 0.8638033869210631, 0.41303358040750027], "sky": [0.1703604245558381, 0.5620064560789615, 0.278252343297936], "sun": [0.6703604245558381, 0.013048227480612695, 0.6849520597606897], "sunHeight": 34.22049421351403, "sunX": -10, "sunZ": -20 },
        { "ground": [0.2880131220445037, 0.04859328449238092, 0.3796174064744264], "edgeDiffuse": [0.009745483519509435, 0.7909441555384547, 0.6388114122673869], "edgeSpecular": [0.08426978811621666, 0.4009459773078561, 0.1], "sky": [0.9475421656388789, 0.31070183283882213, 0.7801487350952812], "sun": [0.44754216563887894, 0.2670146214659326, 0.8620377657935023], "sunHeight": 23.93724723951891, "sunX": -10, "sunZ": -20 },
        { "ground": [0.1918550783302635, 0.00848349763546139, 0.17016820195131002], "edgeDiffuse": [0.22340646223165095, 0.16649690782651305, 0.8517808604519814], "edgeSpecular": [0.9325111464131624, 0.1805583427194506, 0.1], "sky": [0.5692915692925453, 0.5091502659255639, 0.051985894830431784], "sun": [0.06929156929254532, 0.6776507773669437, 0.8611500340048224], "sunHeight": 32.04695578897372, "sunX": -10, "sunZ": -20 },
        { "ground": [0.7786542798858136, 0.01872077537700534, 0.17210561216343193], "edgeDiffuse": [0.8695597273763269, 0.19337252085097134, 0.5087590913753957], "edgeSpecular": [0.5453119068406522, 0.8395739516709, 0.9], "sky": [0.9697636992204934, 0.817114819807466, 0.0034253551508300006], "sun": [0.16400462621822953, 0.9000407499610446, 0.7203783905133605], "sunHeight": 24.271751544438303, "sunX": -10, "sunZ": -20 },
        { "ground": [0.7641974107827991, 0.18257704470306635, 0.3705976016353816], "edgeDiffuse": [0.08048477536067367, 0.027879136614501476, 0.6590158387552947], "edgeSpecular": [0.9388975342735648, 0.36284993565641344, 0.9], "sky": [0.991153679555282, 0.5833358532632701, 0.20358077804557978], "sun": [0.8975722985342145, 0.1951952827279456, 0.6834356694016606], "sunHeight": 11.278230999596417, "sunX": -10, "sunZ": -20 },
        { "ground": [0.11505404696799815, 0.2769950790097937, 0.2675843113102019], "edgeDiffuse": [0.3824837664142251, 0.2170136992353946, 0.8045058909337968], "edgeSpecular": [0.7811404077801853, 0.8443956605624408, 0.9], "sky": [0.27393498248420656, 0.09801816754043102, 0.1276981975417584], "sun": [0.524941275594756, 0.5476423862972296, 0.7505254021380097], "sunHeight": 0.6268654484301805, "sunX": -10, "sunZ": -20 },
        { "ground": [0.7299760221503675, 0.16829125816002488, 0.36264581736177204], "edgeDiffuse": [0.8500837916508317, 0.1700930860824883, 0.9515583487227559], "edgeSpecular": [0.05460134334862232, 0.559947781264782, 0.9], "sky": [0.553601200459525, 0.44560591310728337, 0.20627093730727208], "sun": [0.7541479065548629, 0.11035637155873701, 0.3902272756677121], "sunHeight": 28.629210218787193, "sunX": -10, "sunZ": -20 },
        { "ground": [0.03424867847934365, 0.24970893748104572, 0.2339700106764212], "edgeDiffuse": [0.9708105055615306, 0.8051906037144363, 0.5864241570234299], "edgeSpecular": [0.5895718962419778, 0.007734816521406174, 0.9], "sky": [0.20323747559450567, 0.40935435084393246, 0.05291161616332829], "sun": [0.2918361041229218, 0.5777785128913819, 0.6524845054373145], "sunHeight": 20.058778347447515, "sunX": -10, "sunZ": -20 },
        { "ground": [0.659155149012804, 0.3241475193062797, 0.3774935158202425], "edgeDiffuse": [0.6635389265138656, 0.42894392972812057, 0.9674842429812998], "edgeSpecular": [0.34143570461310446, 0.2035011644475162, 0.9], "sky": [0.8458795319311321, 0.30380122116766867, 0.7961312153027392], "sun": [0.7319814972579479, 0.777670712559484, 0.34765126067213714], "sunHeight": 9.614041435997933, "sunX": -10, "sunZ": -20 },
        { "ground": [0.31365307536907494, 0.13168210128787905, 0.2438298924593255], "edgeDiffuse": [0.9734855722635984, 0.11246964824385941, 0.8724998666439205], "edgeSpecular": [0.12442131922580302, 0.3816414410248399, 0.9], "sky": [0.1619171486236155, 0.47079543254803863, 0.9365154783241451], "sun": [0.003365174401551485, 0.7568901302409358, 0.9060104044619948], "sunHeight": 25.241842574905604, "sunX": -10, "sunZ": -20 },
        { "ground": [0.6109662239905447, 0.36207986960653216, 0.33649018288124355], "edgeDiffuse": [0.9221721889916807, 0.6453256411477923, 0.45816721743904054], "edgeSpecular": [0.1486046880017966, 0.2503110009711236, 0.9], "sky": [0.8095608833245933, 0.3834767167223617, 0.13348899439442902], "sun": [0.37887907959520817, 0.15971482330933212, 0.05684480187483132], "sunHeight": 42.66155809164047, "sunX": -10, "sunZ": -20 },
        { "ground": [0.9307850934565067, 0.4016026617027819, 0.3930977028328925], "edgeDiffuse": [0.17612755158916116, 0.48401014041155577, 0.7269201842136681], "edgeSpecular": [0.2543904255144298, 0.6812272081151605, 0.9], "sky": [0.382698061875999, 0.10301501757930964, 0.07539012086344883], "sun": [0.6328639849089086, 0.43371745091862973, 0.643841129494831], "sunHeight": 18.43554574297741, "sunX": -10, "sunZ": -20 },
        { "ground": [0.14809029386378825, 0.07956705486867577, 0.21754906147252767], "edgeDiffuse": [0.8180114103015512, 0.7490124383475631, 0.8425042678136379], "edgeSpecular": [0.6549975932575762, 0.4148199874907732, 0.9], "sky": [0.4590566710103303, 0.77949988192413, 0.20167006267001852], "sun": [0.6390779295470566, 0.44205471019959075, 0.8372232234105468], "sunHeight": 9.543853567447513, "sunX": -10, "sunZ": -20 },
        { "ground": [0.0027629367541521788, 0.39975991821847856, 0.22562153132166712], "edgeDiffuse": [0.37921418785117567, 0.2955195240210742, 0.27525909221731126], "edgeSpecular": [0.8606252535246313, 0.8849816448055208, 0.9], "sky": [0.8982302565127611, 0.0496136951376684, 0.6592621650663204], "sun": [0.013424655189737678, 0.01697405573213473, 0.8893837954383343], "sunHeight": 20.707437698729336, "sunX": -10, "sunZ": -20 },
        { "ground": [0.8177752429619431, 0.20548845559824258, 0.4269958519376814], "edgeDiffuse": [0.5874866764061153, 0.43259030557237566, 0.6992912690620869], "edgeSpecular": [0.38020698563195765, 0.3185602561570704, 0.9], "sky": [0.1335349406581372, 0.6956112987129017, 0.7139468643348663], "sun": [0.9379130101297051, 0.7218869190663099, 0.7580679538659751], "sunHeight": 48.513824422843754, "sunX": -10, "sunZ": -20 },
        { "ground": [0.5686174905858934, 0.49870168464258313, 0.18347911206074058], "edgeDiffuse": [0.07635964569635689, 0.9370322388131171, 0.6174040110781789], "edgeSpecular": [0.19746890920214355, 0.3064330262131989, 0.9], "sky": [0.00003536767326295376, 0.6841014583129436, 0.2590761701343581], "sun": [0.07067275722511113, 0.1302247737417929, 0.3861791465897113], "sunHeight": 33.630358369555324, "sunX": -10, "sunZ": -20 },
        { "ground": [0.606357216835022, 0.29652302141766995, 0.31465960205532606], "edgeDiffuse": [0.5219893222674727, 0.6319405569229275, 0.7962498483248055], "edgeSpecular": [0.08447954268194735, 0.19300380814820528, 0.9], "sky": [0.5503504080697894, 0.7852984900702722, 0.26960153938271103], "sun": [0.8341788160614669, 0.11185257212491706, 0.02429831656627357], "sunHeight": 0.8512942236848176, "sunX": -10, "sunZ": -20 },
        { "ground": [0.8066499293781817, 0.41545934812165797, 0.3485672381473705], "edgeDiffuse": [0.17307160957716405, 0.4139588684774935, 0.6686820215545595], "edgeSpecular": [0.9338911999948323, 0.10460422514006495, 0.9], "sky": [0.24578420771285892, 0.452998896385543, 0.4195037386380136], "sun": [0.712144463090226, 0.0558374805143103, 0.6675235948059708], "sunHeight": 11.962408712133765, "sunX": -10, "sunZ": -20 },
        { "ground": [0.3240290782414377, 0.17157972743734717, 0.20163741298019885], "edgeDiffuse": [0.8915008956100792, 0.8992370408959687, 0.3794131001923233], "edgeSpecular": [0.40251910546794534, 0.3314438012894243, 0.9], "sky": [0.005906150909140706, 0.5455630852258764, 0.9414904262172058], "sun": [0.3897955168504268, 0.10452161248540505, 0.6933635249733925], "sunHeight": 14.990090567152947, "sunX": -10, "sunZ": -20 },
        { "ground": [0.4972476495895535, 0.13702139246743172, 0.43333705198019745], "edgeDiffuse": [0.002635176293551922, 0.45758383721113205, 0.17834322480484843], "edgeSpecular": [0.3781561322975904, 0.1837167888879776, 0.9], "sky": [0.4061990645714104, 0.6042904052417725, 0.827503539971076], "sun": [0.16995840542949736, 0.4572171956999227, 0.4794684858061373], "sunHeight": 41.31596925435588, "sunX": -10, "sunZ": -20 },
        { "ground": [0.971904682694003, 0.1288349791429937, 0.4126799055375159], "edgeDiffuse": [0.13650480494834483, 0.9675499077420682, 0.8658839240670204], "edgeSpecular": [0.05041080713272095, 0.9489295757375658, 0.9], "sky": [0.9968403147067875, 0.013388064643368124, 0.19597786971135064], "sun": [0.2966317031532526, 0.2955940920859575, 0.9712957059964538], "sunHeight": 15.867480961605906, "sunX": -10, "sunZ": -20 },
        { "ground": [0.6884909039363265, 0.16123810270801187, 0.21454395898617803], "edgeDiffuse": [0.23458832129836082, 0.5776843295898288, 0.679918120848015], "edgeSpecular": [0.9487432900350541, 0.6695387249346823, 0.9], "sky": [0.0512900841422379, 0.8092397845000959, 0.34480088552227245], "sun": [0.14273519231937826, 0.5078890989185311, 0.002284747315570712], "sunHeight": 6.9680484011769295, "sunX": -10, "sunZ": -20 },
        { "ground": [0.5891910120844841, 0.12616359791718423, 0.2939167166361585], "edgeDiffuse": [0.4170501858461648, 0.39543880452401936, 0.7450241260230541], "edgeSpecular": [0.44029323710128665, 0.6032099972944707, 0.9], "sky": [0.6458723032847047, 0.03657189010409638, 0.019149983045645056], "sun": [0.43878768756985664, 0.22828029614174739, 0.3718440132215619], "sunHeight": 18.355233792681247, "sunX": -10, "sunZ": -20 },
        { "ground": [0.23838121304288507, 0.44331066694576293, 0.3536477320594713], "edgeDiffuse": [0.9220187289174646, 0.9140851981937885, 0.07564436667598784], "edgeSpecular": [0.32792859990149736, 0.7039957060478628, 0.9], "sky": [0.001341324532404542, 0.908119088364765, 0.8694517957279458], "sun": [0.44355382421053946, 0.3065846906043589, 0.5496155291330069], "sunHeight": 24.53956719255075, "sunX": -10, "sunZ": -20 },
        { "ground": [0.8942220695316792, 0.34081885137129575, 0.43540818637702616], "edgeDiffuse": [0.8840843606740236, 0.9554115838836879, 0.07924667932093143], "edgeSpecular": [0.11782774981111288, 0.432124278973788, 0.9], "sky": [0.9400721888523549, 0.3479645653278567, 0.13517533420817926], "sun": [0.5571603199932724, 0.592377084493637, 0.7672635603230447], "sunHeight": 41.38545450987294, "sunX": -10, "sunZ": -20 },
        { "ground": [0.03973209788091481, 0.09403322427533567, 0.394566028076224], "edgeDiffuse": [0.3869709863793105, 0.21490064170211554, 0.5646291659213603], "edgeSpecular": [0.3973824670538306, 0.7942950718570501, 0.9], "sky": [0.17523838486522436, 0.5577487738220952, 0.3896357463323511], "sun": [0.0035974301863461733, 0.7268408471369184, 0.590669461293146], "sunHeight": 47.4783411831595, "sunX": -10, "sunZ": -20 },
        { "ground": [0.7255986561067402, 0.19199197366833687, 0.21534360037185252], "edgeDiffuse": [0.45768342493101954, 0.09220417216420174, 0.37658910802565515], "edgeSpecular": [0.11095700622536242, 0.4281248131301254, 0.9], "sky": [0.8874347761739045, 0.2830977124162018, 0.9346763222711161], "sun": [0.009290510090067983, 0.514137590455357, 0.5405457583256066], "sunHeight": 6.600462435744703, "sunX": -10, "sunZ": -20 },
        { "ground": [0.6847865532618016, 0.36584031523671, 0.23223528962116688], "edgeDiffuse": [0.6097017105203122, 0.06698342808522284, 0.6517260516993701], "edgeSpecular": [0.3845288031734526, 0.997776962351054, 0.9], "sky": [0.4964872123673558, 0.5961282936739735, 0.005324520252179354], "sun": [0.1402017311193049, 0.7286943300510756, 0.843098787823692], "sunHeight": 9.677112684585154, "sunX": -10, "sunZ": -20 },
        { "ground": [0.06022322713397443, 0.3376339818350971, 0.449565712083131], "edgeDiffuse": [0.7251110088545829, 0.641343615250662, 0.5986907789483666], "edgeSpecular": [0.04975023306906223, 0.15278406091965735, 0.9], "sky": [0.3513975073583424, 0.7697907155379653, 0.8122269478742964], "sun": [0.24565478274598718, 0.31081069371430203, 0.82903260178864], "sunHeight": 20.779543835669756, "sunX": -10, "sunZ": -20 },
        { "ground": [0.969478104962036, 0.3034523446112871, 0.3687538346741348], "edgeDiffuse": [0.17271867743693292, 0.0670638654846698, 0.18219319265335798], "edgeSpecular": [0.13368061603978276, 0.2164788672234863, 0.9], "sky": [0.9030941426753998, 0.7491858396562747, 0.7522484103799797], "sun": [0.08493204601109028, 0.4876653188257478, 0.1996118100360036], "sunHeight": 46.65940285194665, "sunX": -10, "sunZ": -20 },
    ];

    //

    baker: any;;

    // ui

    @ViewChild('loading') loadingEl: ElementRef;
    loadingElement: any;

    // camera controls

    mouseX: number = 0;
    mouseY: number = 0;

    targetX: number = 0.0;
    targetY: number = 0.0;
    angle: number = 0.0;
    height: number = 0.0;
    target: any = new XG.Vector3(0, 10, 0);

    windowHalfX: number = window.innerWidth / 2;
    windowHalfY: number = window.innerHeight / 2;

    //

    clock: any = new XG.Clock();

    init() {

        // this.container = document.createElement('div');
        // document.body.appendChild(this.container);

        // camera

        this.camera = new XG.PerspectiveCamera(16, this.SCREEN_WIDTH / this.SCREEN_HEIGHT, 1, 1000);
        this.camera.position.set(0, 0, 100);

        // scene

        this.scene = new XG.Scene();
        this.scene.add(this.camera);

        // lights

        this.light = new XG.DayLight(0xffffff, 1);
        this.light.position.set(-0.5, 0.09, -1).multiplyScalar(20);
        this.light.position.y = 16;
        this.scene.add(this.light);

        this.light.castShadow = true;

        var d = 50;

        this.light.shadowCameraLeft = -d * 2;
        this.light.shadowCameraRight = d * 2;
        this.light.shadowCameraTop = d;
        this.light.shadowCameraBottom = -d;

        this.light.shadowCameraNear = 1;
        this.light.shadowCameraFar = 300;
        this.light.shadowDarkness = 1;

        var n = 1;

        this.light.shadowMapWidth = 1024 * n;
        this.light.shadowMapHeight = 1024 * n;

        this.light.sunIntensity = 2;
        this.light.hemiIntensity = 2;
        this.light.skyColor.setHSV(0.6, 0.5, 0.65);
        this.light.groundColor.setHSV(0.01, 0.5, 0.5);

        //


        // objects

        var loader = new XG.UTF8Loader();
        loader.load("lib/models/abstract_mountains.js", (geometries: any, materials: any) => {

            XG.GeometryUtils.center(geometries);

            for (var x = -2; x <= 2; x++) {

                for (var z = 0; z <= 1; z++) {

                    var object = new XG.Mesh(geometries, materials);
                    object.scale.multiplyScalar(2);
                    object.position.x = 90 * x;
                    object.position.z = -180 * z;

                    object.castShadow = true;
                    object.receiveShadow = true;

                    this.scene.add(object);

                    this.zmeshes.push(object);

                }

            }

            this.zgeometries = geometries;
            this.zmaterials = materials;

            var geo = new XG.PlaneGeometry(500, 500);
            var obj = new XG.Mesh(geo, this.zmaterials[2]);
            obj.rotation.x = - Math.PI * 0.5;
            obj.position.y = -10;
            obj.renderDepth = 100;
            this.scene.add(obj);

            this.loadingElement.style.display = "none";

            this.baker = new XG.LightmapBaker(this.renderer);
            this.baker.setup(this.zgeometries, this.zmaterials);

        });

        // renderer

        var pars = {

            "width": this.SCREEN_WIDTH, "height": this.SCREEN_HEIGHT, "scale": this.SCALE,
            "antialias": true,
            "dither": true,
            "tonemapping": XG.Filmic2015Operator,
            "brightness": this.BRIGHTNESS,
            "clearColor": 0x050505, "clearAlpha": 1.0,
            "useMultipleRenderTargets": true

        };

        if (this.useDeferred) {

            this.renderer = new XG.DeferredRenderer(pars);
            this.innerRenderer = this.renderer.renderer;

        } else {

            this.renderer = new XG.ForwardRenderer(pars);
            this.innerRenderer = this.renderer;

        }

        this.containerElement.appendChild(this.renderer.domElement);

        this.renderer.domElement.style.position = "absolute";
        this.renderer.domElement.style.top = this.MARGIN + "px";
        this.renderer.domElement.style.left = "0px";

        //

        this.renderer.shadowMapEnabled = true;
        this.renderer.shadowMapType = XG.PCFSoftHQShadowMap;
        this.renderer.shadowMapSlopeDepthBias = true;
        this.renderer.shadowMapCullFace = XG.CullFaceNone;
        this.renderer.shadowMapUseDepthTextures = true;

        //

        var fogStart = 500;
        var fogStrength = 0.91;

        if (this.useDeferred) {

            this.renderer.dofEnabled = true;
            this.renderer.dofAutofocus = true;
            this.renderer.dofAutofocusPoint.set(0.5, 0.35);
            this.renderer.dofFancy = true;
            this.renderer.dofLensFstop = 4;
            this.renderer.dofLensBlurScale = 40;

            var fovRad = XG.Math.degToRad(this.camera.fov);
            this.renderer.dofLensFocalLength = XG.Math.fovToFocalLength(fovRad, 24);

            this.renderer.fogEnabled = true;
            this.renderer.fogColor.copy(this.light.skyColor);
            this.renderer.fogStart = fogStart;
            this.renderer.fogStrength = fogStrength;

        } else {

            this.scene.fog = new XG.AtmosphericFog(0x000000, fogStart, fogStrength);

            this.scene.fog.color.copy(this.light.skyColor);
            this.renderer.setClearColor(this.light.skyColor, 1);

        }

        //// stats

        //this.stats = new Stats();
        //this.container.appendChild(this.stats.domElement);

        // events

        window.addEventListener('resize', this.onWindowResize.bind(this), false);
        document.addEventListener('mousemove', this.onDocumentMouseMove.bind(this), false);
        document.addEventListener('keydown', this.onDocumentKeyDown.bind(this), false);
        this.renderer.domElement.addEventListener('click', this.onClick.bind(this), false);

        // this.init();

        //var gpuDetector = new GPUDetector();
        //this.gpuData = gpuDetector.detectGPU();

        //if (this.gpuData && this.gpuData.rawScore >= this.ULTRA_THRESHOLD) this.toggleUltra();


    }

    // --------------------------------------------------------------

    toggleUltra() {

        if (!this.isUltra) {

            this.renderer.setScale(1.5);
            this.renderer.dofLensBlurScale = 20;
            this.isUltra = true;

        } else {

            this.renderer.setScale(this.SCALE);
            this.renderer.dofLensBlurScale = 40;
            this.isUltra = false;

        }

    }

    // event handlers

    onWindowResize(event: any) {

        this.SCREEN_WIDTH = window.innerWidth;
        this.SCREEN_HEIGHT = window.innerHeight - 2 * this.MARGIN;

        this.renderer.setSize(this.SCREEN_WIDTH, this.SCREEN_HEIGHT);

        this.camera.aspect = this.SCREEN_WIDTH / this.SCREEN_HEIGHT;
        this.camera.updateProjectionMatrix();

    }

    onDocumentMouseMove(event: any) {

        this.mouseX = (event.clientX - this.windowHalfX) * 1;
        this.mouseY = (event.clientY - this.windowHalfY) * 1;

    }

    // --------------------------------------------------------------

    setColors(params: any) {

        var groundColor = params.ground;
        var h = groundColor[0];
        var s = groundColor[1];
        var v = groundColor[2];

        this.light.groundColor.setHSV(h, s, v);
        this.zmaterials[2].color.setHSV(h, s, v);

        //

        var edgeColor = params.edgeDiffuse;
        var h = edgeColor[0];
        var s = edgeColor[1];
        var v = edgeColor[2];

        this.zmaterials[0].color.setHSV(h, s, v);
        this.zmaterials[4].color.setHSV(h, s, v);

        //

        var edgeSpecular = params.edgeSpecular;
        var h = edgeColor[0];
        var s = edgeColor[1];
        var v = edgeColor[2];

        this.zmaterials[0].specular.setHSV(h, s, v);
        this.zmaterials[4].specular.setHSV(h, s, v);

        //

        var skyColor = params.sky;
        var h = skyColor[0];
        var s = skyColor[1];
        var v = skyColor[2];

        this.light.skyColor.setHSV(h, s, v);

        if (this.useDeferred) {

            this.renderer.fogColor.copy(this.light.skyColor);

        } else {

            this.scene.fog.color.copy(this.light.skyColor);
            this.renderer.setClearColor(this.light.skyColor, 1);

        }

        //

        var sunColor = params.sun;
        var h = sunColor[0];
        var s = sunColor[1];
        var v = sunColor[2];

        this.light.color.setHSV(h, s, v);

        //

        this.light.position.y = params.sunHeight;
        this.light.position.x = (params.sunX !== undefined) ? params.sunX : -10;
        this.light.position.z = (params.sunZ !== undefined) ? params.sunZ : -20;

    }

    randomizeParams(params: any) {

        var h = Math.random();
        var s = Math.random() * 0.5;
        var v = Math.random() * 0.3 + 0.15;

        params.ground[0] = h;
        params.ground[1] = s;
        params.ground[2] = v;

        //

        var h = Math.random();
        var s = Math.random();
        var v = Math.random();

        v = 0.9;

        params.edgeSpecular[0] = h;
        params.edgeSpecular[1] = s;
        params.edgeSpecular[2] = v;

        //

        var h = Math.random();
        var s = Math.random();
        var v = Math.random();

        params.edgeDiffuse[0] = h;
        params.edgeDiffuse[1] = s;
        params.edgeDiffuse[2] = v;

        //

        var h = Math.random();
        var s = Math.random() * 0.95;
        var v = Math.random() * 0.95;

        params.sky[0] = h;
        params.sky[1] = s;
        params.sky[2] = v;

        //

        //h = ( h + 0.5 ) % 1;
        var h = Math.random();
        var s = Math.random() * 0.95;
        var v = Math.random();

        params.sun[0] = h;
        params.sun[1] = s;
        params.sun[2] = v;

        //

        var by = Math.random() * 50;
        var bx = Math.random() * 100 - 50;
        var bz = Math.random() * 100 - 50;

        bx = -10;
        bz = -20;

        params.sunHeight = by;
        params.sunX = bx;
        params.sunZ = bz;

    }

    refreshScene() {

        for (var i = 0, il = this.zmeshes.length; i < il; i++) {

            var mesh = this.zmeshes[i];
            mesh.properties.deferredNeedsUpdate = true;

        }

        this.renderer.shadowMapAutoUpdate = true;

    }

    randomize() {

        var params = { ground: [0, 0, 0], edgeDiffuse: [0, 0, 0], edgeSpecular: [0, 0, 0], sky: [0, 0, 0], sun: [0, 0, 0], sunHeight: 0, sunX: 0, sunZ: 0 };
        this.randomizeParams(params);

        console.log(JSON.stringify(params));

        this.setColors(params);
        this.refreshScene();

    }

    randomPreset() {

        var previousIndex = this.presetIndex;

        do {

            this.presetIndex = XG.Math.randomInt(0, this.presets.length - 1);

        } while (this.presetIndex === previousIndex);

        var params = this.presets[this.presetIndex];

        this.setColors(params);
        this.refreshScene();

    }

    onClick(event: any) {

        this.randomPreset();

    }

    onDocumentKeyDown(event: any) {

        switch (event.keyCode) {

            case 85: /*U*/		if (!event.ctrlKey) this.toggleUltra(); break;
            case 82: /*R*/		if (!event.ctrlKey) this.randomize(); break;
            case 32: /*space*/	this.randomPreset(); break;

        }

    }

    // updates

    animate() {

        requestAnimationFrame(this.animate.bind(this));
        this.render();

        //this.stats.update();

    }

    render() {

        var delta = this.clock.getDelta();

        // update camera

        this.targetX = this.mouseX * 0.04;
        this.targetY = this.mouseY * 0.04;

        this.angle += 0.05 * (this.targetX - this.angle);
        this.height += 0.05 * (this.targetY - this.height);

        var d = 100;
        var x = -Math.sin(this.angle * 0.02) * d;
        var z = Math.cos(this.angle * 0.02) * d + 0;
        var y = 5.0 * this.height + 115;

        this.camera.position.set(x, y, z);
        this.camera.lookAt(this.target);

        // update lightmap

        if (this.baker) {

            this.baker.bake(2, 150);

        }

        // render scene

        this.renderer.render(this.scene, this.camera);

        if (this.zmaterials) {

            this.renderer.shadowMapAutoUpdate = false;

        }

    }

    //


}